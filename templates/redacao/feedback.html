{% extends 'base.html' %}

{% block title %}Feedback da RedaÃ§Ã£o | Verbium{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <header class="mb-8 bg-white p-6 rounded-xl shadow-lg border">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ğŸ“Š Feedback da RedaÃ§Ã£o</h1>
                <p class="text-gray-600 mt-1">{{ entrega.tema.titulo }}</p>
            </div>
            <a href="{% url 'tarefas:lista_redacoes' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                â† Voltar
            </a>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- RedaÃ§Ã£o e CorreÃ§Ã£o -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Texto da RedaÃ§Ã£o -->
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h3 class="text-lg font-semibold mb-4">ğŸ“ Sua RedaÃ§Ã£o</h3>
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="text-sm text-gray-700 whitespace-pre-line">{{ entrega.texto }}</div>
                </div>
                <div class="mt-3 text-sm text-gray-600">
                    ğŸ“Š {{ entrega.palavras_count }} palavras | ğŸ“… Entregue em {{ entrega.data_entrega|date:"d/m/Y H:i" }}
                </div>
            </div>

            <!-- CorreÃ§Ã£o -->
            {% if entrega.correcao %}
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">ğŸ¯ CorreÃ§Ã£o Final</h3>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-green-600">{{ entrega.correcao.nota_total }}/1000</div>
                        <div class="text-sm text-gray-600">NÃ­vel {{ entrega.correcao.nivel_geral }}/5</div>
                    </div>
                </div>
                
                <!-- CompetÃªncias -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-lg font-bold text-blue-600">{{ entrega.correcao.competencia_1 }}</div>
                        <div class="text-xs text-blue-800">C1 - Norma Culta</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-lg font-bold text-green-600">{{ entrega.correcao.competencia_2 }}</div>
                        <div class="text-xs text-green-800">C2 - Tema</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <div class="text-lg font-bold text-yellow-600">{{ entrega.correcao.competencia_3 }}</div>
                        <div class="text-xs text-yellow-800">C3 - ArgumentaÃ§Ã£o</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-lg font-bold text-purple-600">{{ entrega.correcao.competencia_4 }}</div>
                        <div class="text-xs text-purple-800">C4 - CoesÃ£o</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-lg font-bold text-red-600">{{ entrega.correcao.competencia_5 }}</div>
                        <div class="text-xs text-red-800">C5 - Proposta</div>
                    </div>
                </div>

                <!-- ComentÃ¡rios por CompetÃªncia -->
                {% if entrega.correcao.comentario_c1 %}
                <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                    <h4 class="font-semibold text-blue-800 mb-2">ğŸ’¬ C1 - Norma Culta</h4>
                    <p class="text-blue-700 text-sm">{{ entrega.correcao.comentario_c1 }}</p>
                </div>
                {% endif %}

                {% if entrega.correcao.comentario_c2 %}
                <div class="mb-4 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                    <h4 class="font-semibold text-green-800 mb-2">ğŸ’¬ C2 - Tema e Tipologia</h4>
                    <p class="text-green-700 text-sm">{{ entrega.correcao.comentario_c2 }}</p>
                </div>
                {% endif %}

                {% if entrega.correcao.comentario_c3 %}
                <div class="mb-4 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                    <h4 class="font-semibold text-yellow-800 mb-2">ğŸ’¬ C3 - ArgumentaÃ§Ã£o</h4>
                    <p class="text-yellow-700 text-sm">{{ entrega.correcao.comentario_c3 }}</p>
                </div>
                {% endif %}

                {% if entrega.correcao.comentario_c4 %}
                <div class="mb-4 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                    <h4 class="font-semibold text-purple-800 mb-2">ğŸ’¬ C4 - CoesÃ£o</h4>
                    <p class="text-purple-700 text-sm">{{ entrega.correcao.comentario_c4 }}</p>
                </div>
                {% endif %}

                {% if entrega.correcao.comentario_c5 %}
                <div class="mb-4 p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
                    <h4 class="font-semibold text-red-800 mb-2">ğŸ’¬ C5 - Proposta de IntervenÃ§Ã£o</h4>
                    <p class="text-red-700 text-sm">{{ entrega.correcao.comentario_c5 }}</p>
                </div>
                {% endif %}

                {% if entrega.correcao.comentario_geral %}
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“ ComentÃ¡rio Geral</h4>
                    <p class="text-gray-700 text-sm">{{ entrega.correcao.comentario_geral }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Sistema de ComentÃ¡rios -->
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h3 class="text-lg font-semibold mb-4">ğŸ’¬ DiscussÃ£o</h3>
                
                <!-- FormulÃ¡rio para novo comentÃ¡rio -->
                <form method="post" class="mb-6">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea name="comentario" rows="3" placeholder="Escreva sua dÃºvida ou comentÃ¡rio..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                        ğŸ’¬ Adicionar ComentÃ¡rio
                    </button>
                </form>

                <!-- Lista de ComentÃ¡rios -->
                <div class="space-y-4">
                    {% for comentario in comentarios %}
                    <div class="border rounded-lg p-4 {% if comentario.autor.is_superuser %}bg-blue-50 border-blue-200{% else %}bg-gray-50 border-gray-200{% endif %}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="font-semibold {% if comentario.autor.is_superuser %}text-blue-800{% else %}text-gray-800{% endif %}">
                                    {% if comentario.autor.is_superuser %}ğŸ‘¨â€ğŸ«{% else %}ğŸ‘¨â€ğŸ“{% endif %} {{ comentario.autor.first_name|default:comentario.autor.username }}
                                </span>
                                {% if comentario.autor.is_superuser %}
                                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">Professor</span>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500">{{ comentario.data_comentario|date:"d/m/Y H:i" }}</span>
                        </div>
                        <p class="text-gray-700 mb-3">{{ comentario.texto }}</p>
                        
                        <!-- Respostas -->
                        {% if comentario.respostas.all %}
                        <div class="ml-4 space-y-2 border-l-2 border-gray-200 pl-4">
                            {% for resposta in comentario.respostas.all %}
                            <div class="bg-white p-3 rounded border {% if resposta.autor.is_superuser %}border-blue-200{% else %}border-gray-200{% endif %}">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-sm {% if resposta.autor.is_superuser %}text-blue-700{% else %}text-gray-700{% endif %}">
                                        {% if resposta.autor.is_superuser %}ğŸ‘¨â€ğŸ«{% else %}ğŸ‘¨â€ğŸ“{% endif %} {{ resposta.autor.first_name|default:resposta.autor.username }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ resposta.data_comentario|date:"d/m/Y H:i" }}</span>
                                </div>
                                <p class="text-sm text-gray-600">{{ resposta.texto }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- FormulÃ¡rio de resposta -->
                        <div class="mt-3">
                            <button onclick="toggleResposta({{ comentario.id }})" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                ğŸ’¬ Responder
                            </button>
                            <form id="form-resposta-{{ comentario.id }}" method="post" action="{% url 'tarefas:responder_comentario' comentario.id %}" class="hidden mt-2">
                                {% csrf_token %}
                                <div class="flex gap-2">
                                    <textarea name="resposta" rows="2" placeholder="Sua resposta..." 
                                              class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm">
                                        Enviar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">ğŸ’¬</div>
                        <p>Nenhum comentÃ¡rio ainda. Seja o primeiro a comentar!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Painel Lateral -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- AnÃ¡lise IA -->
            {% if entrega.analise_ia %}
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h3 class="text-lg font-semibold mb-4 text-purple-600">ğŸ¤– AnÃ¡lise da IA</h3>
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold text-purple-600">{{ entrega.analise_ia.nota_total_ia }}/1000</div>
                    <div class="text-sm text-gray-600">Nota sugerida pela IA</div>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>C1:</span>
                        <span class="font-semibold">{{ entrega.analise_ia.nota_ia_c1 }}/200</span>
                    </div>
                    <div class="flex justify-between">
                        <span>C2:</span>
                        <span class="font-semibold">{{ entrega.analise_ia.nota_ia_c2 }}/200</span>
                    </div>
                    <div class="flex justify-between">
                        <span>C3:</span>
                        <span class="font-semibold">{{ entrega.analise_ia.nota_ia_c3 }}/200</span>
                    </div>
                    <div class="flex justify-between">
                        <span>C4:</span>
                        <span class="font-semibold">{{ entrega.analise_ia.nota_ia_c4 }}/200</span>
                    </div>
                    <div class="flex justify-between">
                        <span>C5:</span>
                        <span class="font-semibold">{{ entrega.analise_ia.nota_ia_c5 }}/200</span>
                    </div>
                </div>
                
                {% if entrega.analise_ia.analise_geral %}
                <div class="mt-4 p-3 bg-purple-50 rounded border">
                    <h4 class="font-semibold text-purple-800 mb-2">ğŸ“ AnÃ¡lise Geral</h4>
                    <p class="text-purple-700 text-xs">{{ entrega.analise_ia.analise_geral }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Status -->
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h3 class="text-lg font-semibold mb-4">ğŸ“Š Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Entrega:</span>
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… Entregue</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">CorreÃ§Ã£o:</span>
                        {% if entrega.status == 'corrigida' %}
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">âœ… Corrigida</span>
                        {% elif entrega.status == 'ia_analisada' %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">ğŸ¤– IA Analisada</span>
                        {% else %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">â³ Pendente</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Palavras:</span>
                        <span class="font-semibold">{{ entrega.palavras_count }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Dicas -->
            <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-xl border">
                <h3 class="text-lg font-semibold mb-4 text-green-800">ğŸ’¡ Dicas</h3>
                <ul class="text-sm text-green-700 space-y-2">
                    <li>â€¢ Use os comentÃ¡rios para tirar dÃºvidas</li>
                    <li>â€¢ Analise cada competÃªncia separadamente</li>
                    <li>â€¢ Compare com a anÃ¡lise da IA</li>
                    <li>â€¢ Pratique com novos temas</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function toggleResposta(comentarioId) {
    const form = document.getElementById(`form-resposta-${comentarioId}`);
    form.classList.toggle('hidden');
    if (!form.classList.contains('hidden')) {
        form.querySelector('textarea').focus();
    }
}
</script>
{% endblock %}